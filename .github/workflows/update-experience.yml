name: Update Experience Badge

on:
  schedule:
    # Run on the 1st day of every month at 00:00 UTC
    - cron: "0 0 1 * *"
  workflow_dispatch: # Allow manual triggering

jobs:
  update-experience:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Calculate and Update Experience Years
        id: update
        run: |
          python3 << 'EOF'
          from datetime import date
          import re
          import os

          # Calculate experience years
          start_date = date(2021, 7, 1)
          current_date = date.today()
          days = (current_date - start_date).days
          years = days / 365.25
          years_formatted = f"{years:.1f}"

          print(f"ðŸ“… Calculated experience: {years_formatted} years (from {start_date} to {current_date})")

          # Read README.md
          with open('README.md', 'r', encoding='utf-8') as f:
              content = f.read()

          # Pattern to match: Experience-X.X%2B%20Years (where X.X is any number with decimal)
          pattern = r'Experience-[0-9]+\.[0-9]+%2B%20Years'
          replacement = f'Experience-{years_formatted}%2B%20Years'

          # Check if pattern exists
          if not re.search(pattern, content):
              print(f"âš ï¸  Warning: Pattern not found in README.md")
              print(f"   Looking for: Experience-[number].[number]%2B%20Years")
              # Show current content around the badge
              badge_match = re.search(r'Experience-[^"]+', content)
              if badge_match:
                  print(f"   Found: {badge_match.group(0)}")
              # Still write to output to prevent errors
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write(f"updated=false\n")
                  f.write(f"years={years_formatted}\n")
          else:
              # Replace the pattern
              new_content = re.sub(pattern, replacement, content)
              
              if new_content != content:
                  # Write back
                  with open('README.md', 'w', encoding='utf-8') as f:
                      f.write(new_content)
                  print(f"âœ… Successfully updated README: Experience-{years_formatted}%2B%20Years")
                  
                  # Write to GITHUB_OUTPUT for next step
                  with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                      f.write(f"updated=true\n")
                      f.write(f"years={years_formatted}\n")
              else:
                  print(f"â„¹ï¸  No changes needed. Current value is already {years_formatted}")
                  with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                      f.write(f"updated=false\n")
                      f.write(f"years={years_formatted}\n")
          EOF

      - name: Show Changes
        if: steps.update.outputs.updated == 'true'
        run: |
          git diff README.md || echo "No diff available"

      - name: Commit and Push
        if: steps.update.outputs.updated == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add README.md
          git commit -m "ðŸ¤– Auto-update experience badge: ${{ steps.update.outputs.years }} years"
          git push
          echo "âœ… Successfully pushed changes to repository"
