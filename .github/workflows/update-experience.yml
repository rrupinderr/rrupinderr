name: Update Experience Badge

# üìã How to check logs:
# 1. Go to your GitHub repository
# 2. Click on the "Actions" tab (top navigation)
# 3. Click on "Update Experience Badge" workflow in the left sidebar
# 4. Click on the latest run to see detailed logs
# 5. Expand each step to see the output and any errors

on:
  schedule:
    # Run on the 1st day of every month at 00:00 UTC
    - cron: "0 0 1 * *"
  workflow_dispatch: # Allow manual triggering

jobs:
  update-experience:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Calculate and Update Experience Years
        id: update
        run: |
          python3 << 'EOF'
          from datetime import date
          import re
          import os

          # Calculate experience years
          start_date = date(2022, 7, 1)
          current_date = date.today()
          days = (current_date - start_date).days
          years = days / 365.25
          years_formatted = f"{years:.1f}"

          print(f"üìÖ Calculated experience: {years_formatted} years (from {start_date} to {current_date})")

          # Read README.md
          with open('README.md', 'r', encoding='utf-8') as f:
              content = f.read()

          # Simple approach: Find img tag by id and replace just the number in the URL
          # This avoids regex group reference issues
          if 'id="experience-badge"' in content:
              print(f"‚úì Found experience badge with id='experience-badge'")
              
              # Find the img tag with the experience-badge id
              img_match = re.search(r'<img id="experience-badge"[^>]*>', content)
              if img_match:
                  img_tag = img_match.group(0)
                  print(f"   Found img tag")
                  
                  # Extract the current years value from the src URL
                  src_match = re.search(r'src="([^"]*Experience-)([0-9]+\.[0-9]+)(%2B%20Years[^"]*)"', img_tag)
                  if src_match:
                      prefix = src_match.group(1)
                      old_years = src_match.group(2)
                      suffix = src_match.group(3)
                      
                      print(f"   Current value: {old_years} years")
                      
                      if old_years != years_formatted:
                          # Replace the old years with new years in the img tag
                          new_img_tag = img_tag.replace(
                              f'Experience-{old_years}%2B%20Years',
                              f'Experience-{years_formatted}%2B%20Years'
                          )
                          
                          # Replace the img tag in the content
                          new_content = content.replace(img_tag, new_img_tag)
                          
                          # Write back
                          with open('README.md', 'w', encoding='utf-8') as f:
                              f.write(new_content)
                          print(f"‚úÖ Successfully updated: {old_years} ‚Üí {years_formatted} years")
                          
                          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                              f.write(f"updated=true\n")
                              f.write(f"years={years_formatted}\n")
                      else:
                          print(f"‚ÑπÔ∏è  No changes needed. Current value is already {years_formatted} years")
                          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                              f.write(f"updated=false\n")
                              f.write(f"years={years_formatted}\n")
                  else:
                      print(f"‚ö†Ô∏è  Could not extract years value from img tag src")
                      # Fallback: simple string replacement
                      old_pattern = f'Experience-[0-9]+\\.[0-9]+%2B%20Years'
                      new_pattern = f'Experience-{years_formatted}%2B%20Years'
                      if re.search(old_pattern, content):
                          new_content = re.sub(old_pattern, new_pattern, content)
                          if new_content != content:
                              with open('README.md', 'w', encoding='utf-8') as f:
                                  f.write(new_content)
                              print(f"‚úÖ Updated using fallback: {years_formatted} years")
                              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                                  f.write(f"updated=true\n")
                                  f.write(f"years={years_formatted}\n")
                          else:
                              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                                  f.write(f"updated=false\n")
                                  f.write(f"years={years_formatted}\n")
                      else:
                          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                              f.write(f"updated=false\n")
                              f.write(f"years={years_formatted}\n")
              else:
                  print(f"‚ö†Ô∏è  Could not find img tag with id='experience-badge'")
                  with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                      f.write(f"updated=false\n")
                      f.write(f"years={years_formatted}\n")
          else:
              print(f"‚ö†Ô∏è  Warning: img tag with id='experience-badge' not found")
              # Fallback: try simple pattern replacement
              old_pattern = r'Experience-[0-9]+\.[0-9]+%2B%20Years'
              new_pattern = f'Experience-{years_formatted}%2B%20Years'
              if re.search(old_pattern, content):
                  print(f"   Using fallback pattern")
                  new_content = re.sub(old_pattern, new_pattern, content)
                  if new_content != content:
                      with open('README.md', 'w', encoding='utf-8') as f:
                          f.write(new_content)
                      print(f"‚úÖ Updated using fallback: {years_formatted} years")
                      with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                          f.write(f"updated=true\n")
                          f.write(f"years={years_formatted}\n")
                  else:
                      with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                          f.write(f"updated=false\n")
                          f.write(f"years={years_formatted}\n")
              else:
                  with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                      f.write(f"updated=false\n")
                      f.write(f"years={years_formatted}\n")
          EOF

      - name: Show Changes
        if: steps.update.outputs.updated == 'true'
        run: |
          git diff README.md || echo "No diff available"

      - name: Commit and Push
        if: steps.update.outputs.updated == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add README.md
          git commit -m "ü§ñ Auto-update experience badge: ${{ steps.update.outputs.years }} years"
          git push
          echo "‚úÖ Successfully pushed changes to repository"
